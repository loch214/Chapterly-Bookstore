<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${book.title} + ' - Chapterly'">Book Details - Chapterly</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .star { color: gold; font-size: 1.2em; }
        .scroll-row { overflow-x: auto; white-space: nowrap; }
        .scroll-row .card { display: inline-block; min-width: 200px; margin-right: 16px; }
    </style>
    <script>if (localStorage.getItem('darkMode') === 'true') { document.documentElement.classList.add('dark-mode'); document.body.classList.add('dark-mode'); }</script>
</head>
<body>
    <!-- Navbar -->
    <div th:replace="fragments/navbar :: navbar"></div>

    <!-- Main Content -->
    <div class="main-content" id="book-details-container" th:attr="data-book-id=${book.id}">
    <div class="container mt-4 mb-xxl">
        <div class="row">
            <div class="col-md-4">
                <img th:src="${book.imageUrl}" class="img-fluid rounded shadow" alt="Book Cover">
            </div>
            <div class="col-md-8">
                    <h1 th:text="${book.title}" class="fw-bold mb-2">Book Title</h1>
                    <h4 class="text-muted mb-3" th:text="${book.author}">Author Name</h4>
                <div class="mb-2">
                    <span th:each="star : ${#numbers.sequence(1, T(java.lang.Math).round(book.rating))}" class="star">â˜…</span>
                    <span th:text="${book.rating}"></span> / 5
                </div>
                <p class="mb-1"><strong>Category:</strong> <span th:text="${book.category}"></span></p>
                <p class="mb-1"><strong>Stock:</strong> <span th:text="${book.stock}"></span></p>
                <p class="mb-1"><strong>Price:</strong> $<span th:text="${book.price}"></span></p>
                <div class="mt-4 mb-4">
                        <div class="input-group quantity-selector mb-3" style="max-width: 200px;">
                            <button class="btn btn-outline-primary" type="button" onclick="updateQuantity(-1)">-</button>
                            <input type="number" class="form-control text-center" id="quantity" value="1" min="1" th:attr="max=${book.stock}" readonly>
                            <button class="btn btn-outline-primary" type="button" onclick="updateQuantity(1)">+</button>
                    </div>
                        <button class="btn btn-warning btn-add-to-cart me-2" onclick="addToCart()">Add to Cart</button>
                        <button class="btn btn-wishlist me-2" onclick="addToWishlist()" title="Add to Wishlist">
                            <i class="bi bi-heart-fill"></i>
                    </button>
                        <button class="btn btn-success btn-buy-now" onclick="buyNow()">Buy Now</button>
                </div>
                <div class="mb-4 p-3 bg-light rounded shadow-sm">
                    <h5 class="fw-bold">Book Description</h5>
                    <p th:text="${book.longDescription}">No description available.</p>
                </div>
                <div class="mb-4 p-3 bg-light rounded shadow-sm">
                    <h5 class="fw-bold">About the Author</h5>
                    <p th:text="${book.authorBio}">Author bio coming soon.</p>
                </div>
            </div>
        </div>
        <hr class="my-4">
        <h4>More from this category</h4>
        <div class="scroll-row" id="category-row">
            <div class="card" th:each="b : ${relatedCategory}">
                <img th:src="${b.imageUrl}" class="card-img-top" style="height: 120px; object-fit: cover;">
                <div class="card-body">
                    <h5 class="card-title" th:text="${b.title}">Book Title</h5>
                    <p class="card-text" th:text="${b.author}">Author</p>
                    <p class="card-text">$<span th:text="${b.price}">0.00</span></p>
                    <a th:href="@{/book/{id}(id=${b.id})}" class="btn btn-primary">View Details</a>
                </div>
            </div>
        </div>
        <hr class="my-4">
        <h4>More from this author</h4>
        <div class="scroll-row" id="author-row">
            <div class="card" th:each="b : ${relatedAuthor}">
                <img th:src="${b.imageUrl}" class="card-img-top" style="height: 120px; object-fit: cover;">
                <div class="card-body">
                    <h5 class="card-title" th:text="${b.title}">Book Title</h5>
                    <p class="card-text" th:text="${b.category}">Category</p>
                    <p class="card-text">$<span th:text="${b.price}">0.00</span></p>
                    <a th:href="@{/book/{id}(id=${b.id})}" class="btn btn-primary">View Details</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="fragments/footer :: footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/darkmode.js"></script>
    <div th:replace="fragments/navbar :: darkmode-script"></div>
    <script>
        // Helper for login modal (if needed)
        const loginRequiredModal = {
            show: function() { window.location.href = '/login'; }
        };

        function getBookId() {
            // Get bookId from data attribute
            const container = document.getElementById('book-details-container');
            return container ? container.getAttribute('data-book-id') : 0;
        }

        function getQuantity() {
            const qtyInput = document.getElementById('quantity');
            return qtyInput ? parseInt(qtyInput.value) : 1;
        }

        function checkAuth(callback, action, bookId, quantity) {
            fetch('/auth/status')
                .then(response => response.json())
                .then(data => {
                    if (data.loggedIn) {
                        callback();
                    } else {
                        // Save the user's intent before redirecting
                        if (action) {
                            const currentPage = window.location.href;
                            fetch('/auth/save-intent', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: `action=${action}&bookId=${bookId || ''}&quantity=${quantity || ''}&currentPage=${encodeURIComponent(currentPage)}`
                            });
                        }
                        loginRequiredModal.show();
                    }
                })
                .catch(() => {
                    alert('Could not verify authentication status. Please check your connection.');
                });
        }

        function addToCart(bookId) {
            if (!bookId) bookId = getBookId();
            const quantity = getQuantity();
            checkAuth(() => {
                fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `bookId=${bookId}&quantity=${quantity}`
                })
                .then(response => response.text())
                .then(result => {
                    if (result === 'success') {
                        alert('Book added to cart successfully!');
                        updateCartCount();
                    } else {
                        alert('Error adding book to cart. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error adding book to cart. Please try again.');
                });
            }, 'addToCart', bookId, quantity);
        }

        function addToWishlist(bookId) {
            if (!bookId) bookId = getBookId();
            checkAuth(() => {
                fetch('/wishlist/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `bookId=${bookId}`
                })
                .then(response => response.text())
                .then(result => {
                    if (result === 'success') {
                        alert('Book added to wishlist successfully!');
                        updateWishlistCount();
                    } else {
                        alert('Error adding book to wishlist. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error adding book to wishlist. Please try again.');
                });
            }, 'addToWishlist', bookId, '1');
        }

        function buyNow(bookId) {
            if (!bookId) bookId = getBookId();
            const quantity = getQuantity();
            checkAuth(() => {
                fetch('/cart/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `bookId=${bookId}&quantity=${quantity}&buyNow=true`
                })
                .then(response => response.text())
                .then(result => {
                    if (result === 'buy_now_success') {
                        window.location.href = '/order/checkout';
                    } else if (result === 'success') {
                        window.location.href = '/order/checkout?buyNow=true&bookId=' + bookId + '&quantity=' + quantity;
                    } else {
                        alert('Error adding book to cart. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error adding book to cart. Please try again.');
                });
            }, 'buyNow', bookId, quantity);
        }

        function updateCartCount() {
            fetch('/cart/count')
                .then(response => response.text())
                .then(count => {
                    const cartCountElement = document.getElementById('cartCount');
                    if (cartCountElement) cartCountElement.textContent = count;
                })
                .catch(error => {
                    console.error('Error updating cart count:', error);
                });
        }

        function updateWishlistCount() {
            fetch('/wishlist/count')
                .then(response => response.text())
                .then(count => {
                    const wishlistCountElement = document.getElementById('wishlistCount');
                    if (wishlistCountElement) {
                        wishlistCountElement.textContent = count;
                        if (parseInt(count) > 0) {
                            wishlistCountElement.style.display = 'block';
                        } else {
                            wishlistCountElement.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error updating wishlist count:', error);
                });
        }

        // On page load, update counts
        updateCartCount();
        updateWishlistCount();

        // Quantity selector logic
        function updateQuantity(delta) {
            const qtyInput = document.getElementById('quantity');
            if (!qtyInput) return;
            let value = parseInt(qtyInput.value) || 1;
            const max = parseInt(qtyInput.getAttribute('max')) || 99;
            value += delta;
            if (value < 1) value = 1;
            if (value > max) value = max;
            qtyInput.value = value;
        }
    </script>
</body>
</html> 